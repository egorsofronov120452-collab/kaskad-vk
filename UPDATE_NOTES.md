# Обновления VK бота

## Версия 2.0 - Полная поддержка вложений и расширенный функционал

### Что нового:

#### 1. Команда !инвайт - Улучшенная система приглашений

**Изменения:**
- Исправлен порядок ролей: **рс, сс, курьер, стажёр, спонсор**
- Улучшенная обработка ошибок с отчётом о неудачных приглашениях
- Более подробное логирование в консоль

**Роли:**
- **рс** - Все чаты (включая Руководство)
- **сс** - Все чаты кроме Руководства
- **курьер** - Флудилка, Журнал Активности, Диспетчерская, Доска Объявлений
- **стажёр** - Учебный Центр, Доска Объявлений, Диспетчерская
- **спонсор** - Дополнительная роль, только чат Спонсорства

#### 2. Команда !пост - Поддержка всех вложений

**Новые возможности:**
- ✅ Фотографии (со сжатием)
- ✅ Видео
- ✅ Аудио
- ✅ Документы
- ✅ Опросы
- ✅ Записи со стены

**Использование:**
```
1. Создайте сообщение с текстом и прикрепите файлы
2. Ответьте на него командой !пост
3. Всё автоматически опубликуется в группе
```

#### 3. Команда !приветствие - Вложения и кросс-чат установка

**Новые возможности:**
- ✅ Поддержка всех типов вложений (фото, видео, гифки, документы и т.д.)
- ✅ Возможность установить приветствие для любого чата

**Использование:**
```
!приветствие [id чата] (ответом на сообщение)
```

**Примеры:**
```
!приветствие
```
Установит для текущего чата

```
!приветствие 123
```
Установит для чата с ID 123

**Как создать приветствие с фото:**
1. Напишите текст приветствия (используйте {user} для упоминания)
2. Прикрепите фото/гифку/видео
3. Ответьте на своё сообщение: `!приветствие`

#### 4. Команда !закреп - Вложения и кросс-чат закрепление

**Новые возможности:**
- ✅ Поддержка всех типов вложений
- ✅ Возможность отправить и закрепить сообщение в любом чате

**Режимы работы:**

1. **Локальный закреп** (без указания ID чата):
   - Закрепляет сообщение в текущем чате

2. **Удалённый закреп** (с указанием ID чата):
   - Копирует сообщение со всеми вложениями в указанный чат
   - Автоматически закрепляет его там

**Использование:**
```
!закреп [id чата] (ответом на сообщение)
```

**Примеры:**
```
!закреп
```
Закрепит в текущем чате

```
!закреп 123
```
Отправит и закрепит в чате 123

### Технические улучшения:

1. **Новая функция `collectAttachments()`**
   - Универсальный сборщик вложений из сообщений
   - Поддерживает: photo, video, audio, doc, wall, poll

2. **Улучшенное хранилище приветствий**
   - Теперь хранит и текст, и вложения
   - Формат: `{ text: string, attachments: array }`

3. **Обновлённая функция `handleChatJoin()`**
   - Отправляет приветствия с вложениями новым участникам

4. **Лучшая обработка ошибок**
   - Подробные логи в консоль
   - Информативные сообщения пользователю

### Миграция:

Если у вас уже установлены приветствия, их нужно установить заново с помощью обновлённой команды `!приветствие`, чтобы использовать новый функционал вложений.

### Документация:

Полная документация по командам доступна в файле `VK_BOT_COMMANDS.md`

### Запуск:

```bash
# Обычный запуск
node scripts/long-polling.cjs

# PM2
pm2 restart vk-bot
```

### Проверка работы:

1. **Тест !инвайт:**
   ```
   !инвайт vk.com/id123 стажёр
   ```

2. **Тест !пост с фото:**
   - Напишите сообщение с фото
   - Ответьте: `!пост`

3. **Тест !приветствие с гифкой:**
   - Напишите "Привет, {user}!" и прикрепите гифку
   - Ответьте: `!приветствие`

4. **Тест !закреп в другой чат:**
   - Напишите сообщение с фото
   - Ответьте: `!закреп 123` (где 123 - ID чата)

### Поддержка:

При возникновении проблем проверьте:
1. Логи бота: `pm2 logs vk-bot` или консоль
2. Права бота в чатах (должен быть администратором)
3. Токены в .env файле
4. ID чатов в .env файле
